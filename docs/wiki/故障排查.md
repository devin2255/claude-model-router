# 故障排查

## 常见问题速查

### 启动问题

#### Q: 提示 "'model-router' 不是内部或外部命令"

**原因**：未添加到 PATH 或文件不存在

**解决**：
```powershell
# 检查文件是否存在
Get-Command model-router.cmd -ErrorAction SilentlyContinue

# 添加到 PATH（临时）
$env:PATH += ";D:\path\to\model-router"

# 添加到 PATH（永久）
[Environment]::SetEnvironmentVariable(
    "PATH",
    [Environment]::GetEnvironmentVariable("PATH", "User") + ";D:\path\to\model-router",
    "User"
)
```

#### Q: 提示 "python 不是内部或外部命令"

**原因**：Python 未安装或未添加到 PATH

**解决**：
1. 安装 Python 3.6+ 并勾选 "Add to PATH"
2. 或使用 Python 完整路径：
```batch
@echo off
setlocal
C:\Python39\python.exe "%~dp0model-router.py" %*
```

---

### 权限问题

#### Q: 提示 "写入系统环境变量失败"

**原因**：没有管理员权限

**现象**：
```
写入系统环境变量失败：kimi
提示：请以管理员身份运行以写入系统环境变量。
当前仅在本进程生效，打开新终端可能失效。
```

**解决**：

**方案一：以管理员身份运行**
```powershell
# 右键点击 PowerShell/CMD 选择"以管理员身份运行"
# 然后执行
model-router kimi
```

**方案二：接受用户级配置**
- 忽略警告，在当前终端直接使用
- 注意：新终端需要重新运行命令

**方案三：手动设置环境变量**
```powershell
# 手动设置用户环境变量
[Environment]::SetEnvironmentVariable("ANTHROPIC_BASE_URL", "https://api.moonshot.cn/anthropic", "User")
[Environment]::SetEnvironmentVariable("ANTHROPIC_MODEL", "kimi-k2.5", "User")
# ... 其他变量
```

---

### 环境变量问题

#### Q: 切换模型后 Claude Code 仍使用旧配置

**原因**：环境变量未在新进程中生效

**解决**：

1. **完全关闭当前终端**（不仅仅是关闭窗口，要确保进程结束）
2. **打开新终端窗口**
3. **验证环境变量**：
```powershell
echo $env:ANTHROPIC_BASE_URL
echo $env:ANTHROPIC_MODEL
```
4. **重新运行**：
```batch
model-router claude
```

#### Q: 环境变量显示正确但 Claude Code 不识别

**原因**：Claude Code 进程启动时读取了旧的环境变量

**解决**：
```powershell
# 1. 完全退出 Claude Code
# 2. 在新终端中验证变量
Get-ChildItem Env: | Where-Object { $_.Name -like "ANTHROPIC*" }
# 3. 重新启动
model-router claude
```

---

### 代理服务器问题

#### Q: OpenAI 模式提示 "转换代理启动失败"

**诊断步骤**：

```powershell
# 1. 检查端口占用
netstat -ano | findstr 19000

# 2. 检查代理进程
Get-CimInstance Win32_Process | Where-Object { $_.CommandLine -like "*model-router-proxy.py*" }

# 3. 手动启动代理查看错误
python model-router-proxy.py --host 127.0.0.1 --port 19000
```

**常见原因和解决**：

| 原因 | 现象 | 解决 |
|------|------|------|
| 端口被占用 | `netstat` 显示端口在使用 | 更换端口：`set MODEL_ROUTER_PROXY_PORT=19001` |
| 代理文件缺失 | 提示 "缺少 model-router-proxy.py" | 确保两个 py 文件在同一目录 |
| Python 错误 | 手动启动显示语法错误 | 检查 Python 版本 >= 3.6 |

#### Q: 代理健康检查失败

**测试**：
```powershell
# 检查代理健康
curl http://127.0.0.1:19000/health

# 预期响应
{"status": "ok", "proxy": "model-router", "version": "1.1", ...}
```

**解决**：
```batch
# 强制重启代理
model-router openai

# 或手动终止后重启
taskkill /F /IM python.exe /FI "COMMANDLINE eq *model-router-proxy.py*"
model-router openai
```

#### Q: 提示 "检测到旧版转换代理"

**原因**：已运行的代理版本不兼容

**解决**：
```batch
# 自动处理（推荐）
model-router openai

# 手动处理
# 1. 终止所有代理进程
taskkill /F /IM python.exe /FI "COMMANDLINE eq *model-router-proxy.py*"
# 2. 重新启动
model-router openai
```

---

### 网络问题

#### Q: IP 检测失败，总是使用 openai

**诊断**：
```powershell
# 手动测试 IP 检测
python -c "
import urllib.request, json
req = urllib.request.Request('https://ipapi.co/json/', headers={'User-Agent': 'test'})
with urllib.request.urlopen(req, timeout=5) as resp:
    print(json.loads(resp.read().decode()))
"
```

**解决**：
- 检查网络连接
- 检查是否使用代理/VPN
- 手动指定模型：`model-router kimi`

#### Q: OpenAI API 连接超时

**原因**：
- 网络限制（中国大陆）
- 代理配置错误
- API Key 无效

**解决**：

**方案一：使用 Kimi（推荐国内用户）**
```batch
model-router kimi
```

**方案二：使用自定义上游**
```batch
set MODEL_ROUTER_OPENAI_BASE_URL=https://your-proxy-domain.com/v1
model-router openai
```

**方案三：检查 API Key**
```powershell
# 验证 API Key 是否设置
echo $env:ANTHROPIC_AUTH_TOKEN
```

---

### Claude CLI 问题

#### Q: `model-router claude` 提示找不到 claude 命令

**原因**：Claude CLI 未安装或未添加到 PATH

**解决**：
```powershell
# 检查是否安装
Get-Command claude -ErrorAction SilentlyContinue

# 如果未安装，使用 npm 安装
npm install -g @anthropic-ai/claude-code

# 或使用 npx
npx @anthropic-ai/claude-code
```

#### Q: Claude CLI 启动后 API 调用失败

**诊断**：
```powershell
# 1. 检查当前配置
model-router claude -- --version

# 2. 测试代理（OpenAI 模式）
curl http://127.0.0.1:19000/health

# 3. 查看 Claude 日志
claude --verbose
```

---

## 诊断命令汇总

### 环境检查

```powershell
# 查看所有相关环境变量
Get-ChildItem Env: | Where-Object {
    $_.Name -match "MODEL_ROUTER|ANTHROPIC|CLAUDE_CODE|OPENAI"
}

# 查看注册表中的配置
Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment" |
    Select-Object MODEL_ROUTER_*, ANTHROPIC_*, CLAUDE_CODE_*

Get-ItemProperty "HKCU:\Environment" |
    Select-Object MODEL_ROUTER_*, ANTHROPIC_*, CLAUDE_CODE_*
```

### 进程检查

```powershell
# 查看代理进程
Get-CimInstance Win32_Process |
    Where-Object { $_.CommandLine -like "*model-router*" } |
    Select-Object ProcessId, CommandLine

# 查看端口占用
netstat -ano | findstr 19000

# 查看监听端口
Get-NetTCPConnection -LocalPort 19000
```

### 网络测试

```powershell
# 测试 IP 检测服务
curl https://ipapi.co/json/ | ConvertFrom-Json | Select-Object country_code

# 测试代理健康
curl http://127.0.0.1:19000/health

# 测试 API 连通性（需要替换 API key）
curl -X POST http://127.0.0.1:19000/v1/messages `
  -H "Authorization: Bearer $env:ANTHROPIC_AUTH_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{"model": "gpt-4", "messages": [{"role": "user", "content": "test"}], "max_tokens": 10}'
```

## 重置到初始状态

如果需要完全重置配置：

```powershell
# 1. 终止所有代理进程
taskkill /F /IM python.exe /FI "COMMANDLINE eq *model-router-proxy.py*" 2>$null

# 2. 删除所有相关环境变量（用户级别）
$vars = @(
    "MODEL_ROUTER_ACTIVE_MODEL",
    "MODEL_ROUTER_PROXY_URL",
    "MODEL_ROUTER_OPENAI_BASE_URL",
    "ANTHROPIC_BASE_URL",
    "ANTHROPIC_MODEL",
    "ANTHROPIC_DEFAULT_OPUS_MODEL",
    "ANTHROPIC_DEFAULT_SONNET_MODEL",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL",
    "CLAUDE_CODE_SUBAGENT_MODEL",
    "ANTHROPIC_AUTH_TOKEN"
)

foreach ($var in $vars) {
    Remove-ItemProperty -Path "HKCU:\Environment" -Name $var -ErrorAction SilentlyContinue
    Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment" -Name $var -ErrorAction SilentlyContinue
}

# 3. 重启终端
# 4. 重新运行 model-router
```

## 获取帮助

如果以上方法无法解决问题：

1. **查看详细错误**：手动运行 Python 脚本查看完整错误堆栈
```powershell
python model-router.py openai
```

2. **检查日志**：代理服务器会输出错误信息到控制台

3. **验证安装**：确保所有文件完整
```powershell
Get-FileHash model-router.py
Get-FileHash model-router-proxy.py
```

## 相关源码文件

- `model-router.py:78-83` - 系统环境变量写入
- `model-router.py:145-159` - 代理健康检查
- `model-router.py:302-337` - 代理进程终止
- `model-router.py:400-443` - 代理生命周期管理
- `model-router-proxy.py:629-664` - 健康检查端点
