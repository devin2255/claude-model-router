# 配置说明

## 环境变量

model-router 使用环境变量进行配置管理。切换模型时会自动设置这些变量。

## 配置文件

默认读取 `model-router.config.json`（可参考
`model-router.config.example.json`）。也可以通过
`MODEL_ROUTER_CONFIG` 指定自定义路径。

建议先运行 `model-router init` 自动生成本地配置模板。
若未安装 Python，`model-router init` 会尝试通过 `winget` 自动安装。

### 核心配置变量

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `MODEL_ROUTER_ACTIVE_MODEL` | 当前激活的模型 | `kimi` / `openai` |
| `MODEL_ROUTER_PROXY_URL` | 代理服务器地址 | `http://127.0.0.1:19000` |
| `MODEL_ROUTER_OPENAI_BASE_URL` | OpenAI 上游地址 | `https://api.openai.com/v1` |

### Claude Code 相关变量

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `ANTHROPIC_BASE_URL` | API 基础地址 | `https://api.moonshot.cn/anthropic` |
| `ANTHROPIC_AUTH_TOKEN` | 认证令牌 | `sk-...` |
| `ANTHROPIC_MODEL` | 默认模型 | `kimi-k2.5` / `gpt-5.2-codex` |
| `ANTHROPIC_DEFAULT_OPUS_MODEL` | Opus 级别模型 | `kimi-k2.5` |
| `ANTHROPIC_DEFAULT_SONNET_MODEL` | Sonnet 级别模型 | `kimi-k2.5` |
| `ANTHROPIC_DEFAULT_HAIKU_MODEL` | Haiku 级别模型 | `kimi-k2.5` |
| `CLAUDE_CODE_SUBAGENT_MODEL` | 子代理模型 | `kimi-k2.5` |

### 代理服务器变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `MODEL_ROUTER_PROXY_HOST` | 代理监听主机 | `127.0.0.1` |
| `MODEL_ROUTER_PROXY_PORT` | 代理监听端口 | `19000` |
| `MODEL_ROUTER_FORCE_RESPONSES` | 强制使用 Responses API | `false` |

### OpenAI 上游配置

| 变量名 | 说明 | 优先级 |
|--------|------|--------|
| `MODEL_ROUTER_OPENAI_BASE_URL` | 自定义 OpenAI 地址 | 最高 |
| `OPENAI_BASE_URL` | OpenAI 基础地址 | 中 |
| `OPENAI_API_BASE` | OpenAI API 基础地址 | 低 |

## 模型预设配置

### Kimi 配置

```python
{
    "ANTHROPIC_BASE_URL": "https://api.moonshot.cn/anthropic",
    "ANTHROPIC_AUTH_TOKEN": "REPLACE_ME",
    "ANTHROPIC_MODEL": "kimi-k2.5",
    "ANTHROPIC_DEFAULT_OPUS_MODEL": "kimi-k2.5",
    "ANTHROPIC_DEFAULT_SONNET_MODEL": "kimi-k2.5",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "kimi-k2.5",
    "CLAUDE_CODE_SUBAGENT_MODEL": "kimi-k2.5",
}
```

### OpenAI 配置

```python
{
    "ANTHROPIC_BASE_URL": "http://127.0.0.1:19000",  # 代理地址
    "ANTHROPIC_AUTH_TOKEN": "REPLACE_ME",
    "ANTHROPIC_MODEL": "gpt-5.2-codex",
    "ANTHROPIC_DEFAULT_OPUS_MODEL": "gpt-5.2-codex",
    "ANTHROPIC_DEFAULT_SONNET_MODEL": "gpt-5.2-codex",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "gpt-5.2-codex",
    "CLAUDE_CODE_SUBAGENT_MODEL": "gpt-5.2-codex",
}
```

## 自定义配置

### 使用第三方 OpenAI 兼容服务

```batch
# 设置上游地址
set MODEL_ROUTER_OPENAI_BASE_URL=https://api.openrouter.ai/api/v1

# 切换到 openai 模式
model-router openai
```

### 自定义代理端口

```batch
# 设置代理端口
set MODEL_ROUTER_PROXY_PORT=19001

# 切换到 openai 模式
model-router openai
```

### 强制使用 Responses API

```batch
# 强制所有模型使用 Responses API
set MODEL_ROUTER_FORCE_RESPONSES=1

# 切换到 openai 模式
model-router openai
```

## Windows 注册表存储

### 存储位置

**系统级别**（需要管理员权限）：
```
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment
```

**用户级别**：
```
HKEY_CURRENT_USER\Environment
```

### 查看当前配置

```powershell
# 查看系统环境变量
Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment" |
    Select-Object MODEL_ROUTER_*, ANTHROPIC_*, CLAUDE_CODE_*

# 查看用户环境变量
Get-ItemProperty "HKCU:\Environment" |
    Select-Object MODEL_ROUTER_*, ANTHROPIC_*, CLAUDE_CODE_*
```

### 手动清理配置

```powershell
# 删除所有 model-router 相关变量
$keys = @(
    "MODEL_ROUTER_ACTIVE_MODEL",
    "MODEL_ROUTER_PROXY_URL",
    "MODEL_ROUTER_OPENAI_BASE_URL",
    "ANTHROPIC_BASE_URL",
    "ANTHROPIC_MODEL",
    "ANTHROPIC_DEFAULT_OPUS_MODEL",
    "ANTHROPIC_DEFAULT_SONNET_MODEL",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL",
    "CLAUDE_CODE_SUBAGENT_MODEL",
    "ANTHROPIC_AUTH_TOKEN"
)

foreach ($key in $keys) {
    Remove-ItemProperty -Path "HKCU:\Environment" -Name $key -ErrorAction SilentlyContinue
}
```

## 配置优先级

### 代理地址解析

1. `MODEL_ROUTER_PROXY_URL` 环境变量
2. 默认值 `http://127.0.0.1:19000`

### OpenAI 上游地址解析

1. `MODEL_ROUTER_OPENAI_BASE_URL` 环境变量
2. `OPENAI_BASE_URL` 环境变量
3. `OPENAI_API_BASE` 环境变量
4. 默认值 `https://api.openai.com/v1`

### 模型选择

1. 命令行参数（`kimi` / `openai`）
2. `model-router model` 自动检测
3. 已存在的 `MODEL_ROUTER_ACTIVE_MODEL`

## 配置文件示例

### 批处理脚本（setup-env.bat）

```batch
@echo off
set MODEL_ROUTER_OPENAI_BASE_URL=https://your-custom-api.com/v1
set MODEL_ROUTER_PROXY_PORT=19001

model-router openai
echo 环境配置完成，请打开新终端使用
```

### PowerShell 脚本（setup-env.ps1）

```powershell
$env:MODEL_ROUTER_OPENAI_BASE_URL = "https://your-custom-api.com/v1"
$env:MODEL_ROUTER_PROXY_PORT = "19001"

model-router openai
Write-Host "环境配置完成，请打开新终端使用" -ForegroundColor Green
```

## 相关源码文件

- `model-router.py:15-52` - 配置常量和模型预设
- `model-router.py:104-116` - 代理地址解析
- `model-router.py:119-126` - OpenAI 模型默认值应用
- `model-router-proxy.py:21-28` - 上游地址解析
- `model-router-proxy.py:45-60` - Responses API 判断逻辑
