# 开发指南

## 开发环境

### 系统要求

- **操作系统**：Windows 10/11
- **Python**：3.6 或更高版本
- **PowerShell**：5.1 或更高版本（可选）

### 验证环境

```powershell
# 检查 Python 版本
python --version

# 检查是否支持所需模块
python -c "import ctypes, winreg, urllib.request; print('OK')"
```

## 代码结构

### 项目文件关系

```
model-router/
├── model-router.py          # 主程序（715 行）
│   ├── 命令行参数解析
│   ├── 环境变量管理
│   ├── IP 地理检测
│   └── 代理进程管理
│
├── model-router-proxy.py    # 代理服务器（909 行）
│   ├── HTTP 服务器
│   ├── 协议转换
│   └── 流式响应处理
│
├── model-router.cmd         # Windows 批处理入口
└── mr.cmd                   # 简写别名入口
```

### 主程序模块

```
model-router.py
├── 导入模块（1-12 行）
├── 配置常量（15-56 行）
├── 注册表操作（58-101 行）
├── 代理管理（104-261 行）
├── 代理生命周期（264-443 行）
├── 模型配置（446-477 行）
├── 环境刷新（480-509 行）
├── 配置输出（512-534 行）
├── 参数解析（536-562 行）
├── Claude CLI（565-593 行）
├── IP 检测（596-673 行）
└── 主函数（676-714 行）
```

### 代理服务器模块

```
model-router-proxy.py
├── 导入模块（1-9 行）
├── 配置常量（12-18 行）
├── 上游配置（21-42 行）
├── API 选择（45-60 行）
├── 错误处理（63-84 行）
├── 内容转换（87-106 行）
├── 工具映射（109-169 行）
├── 消息转换（172-279 行）
├── 请求转换（282-333 行）
├── 响应转换（336-439 行）
├── API 提取（442-449 行）
├── 流式写入（452-627 行）
├── HTTP 处理（629-880 行）
└── 主函数（883-908 行）
```

## 核心逻辑说明

### 环境变量广播

```python
def _broadcast_env_change():
    """广播环境变量变更通知，使其他程序立即感知变化"""
    HWND_BROADCAST = 0xFFFF
    WM_SETTINGCHANGE = 0x001A
    SMTO_ABORTIFHUNG = 0x0002
    ctypes.windll.user32.SendMessageTimeoutW(
        HWND_BROADCAST,
        WM_SETTINGCHANGE,
        0,
        "Environment",
        SMTO_ABORTIFHUNG,
        5000,
        None,
    )
```

### 注册表操作

```python
def set_env_system(name, value):
    """设置系统环境变量（需要管理员权限）"""
    try:
        with winreg.OpenKey(
            winreg.HKEY_LOCAL_MACHINE,
            r"SYSTEM\CurrentControlSet\Control\Session Manager\Environment",
            0,
            winreg.KEY_SET_VALUE
        ) as key:
            winreg.SetValueEx(key, name, 0, winreg.REG_SZ, value)
        return True
    except PermissionError:
        return False
```

### 代理进程管理

```python
def _list_proxy_processes():
    """使用 PowerShell 或 ps 命令查找代理进程"""
    # Windows: 使用 Get-CimInstance Win32_Process
    # Unix: 使用 ps -ax
    pass

def _terminate_proxy_processes(proxy_url):
    """终止代理进程并清理端口占用"""
    # 1. 终止所有 model-router-proxy.py 进程
    # 2. 检查端口占用并终止
    pass

def ensure_proxy_running(proxy_url, upstream_url, force_restart=False):
    """确保代理服务器运行"""
    # 1. 检查现有代理健康状态
    # 2. 如需要，终止旧进程
    # 3. 启动新进程
    # 4. 等待健康检查通过
    pass
```

### 协议转换核心

```python
def anthropic_to_openai(payload):
    """将 Anthropic 请求转换为 OpenAI 格式"""
    openai_payload = {}
    # 映射基本参数
    if "max_tokens" in payload:
        openai_payload["max_tokens"] = payload["max_tokens"]
    # 转换消息格式
    messages = []
    for msg in payload.get("messages", []):
        messages.extend(_convert_anthropic_message(msg))
    openai_payload["messages"] = messages
    return openai_payload
```

## 调试技巧

### 启用详细输出

修改代码临时添加日志：

```python
import logging
logging.basicConfig(level=logging.DEBUG)

# 在关键位置添加
print(f"[DEBUG] 当前代理状态: {health}")
```

### 手动测试代理

```powershell
# 启动代理（前台运行，便于查看日志）
python model-router-proxy.py --host 127.0.0.1 --port 19000

# 测试健康检查
curl http://127.0.0.1:19000/health

# 测试消息接口
curl -X POST http://127.0.0.1:19000/v1/messages `
  -H "Authorization: Bearer your-api-key" `
  -H "Content-Type: application/json" `
  -d '{"model": "gpt-4", "messages": [{"role": "user", "content": "Hello"}]}'
```

### 检查环境变量

```powershell
# 查看所有相关变量
Get-ChildItem Env: | Where-Object { $_.Name -match "MODEL_ROUTER|ANTHROPIC|CLAUDE_CODE" }

# 查看注册表中的值
Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment" -Name "ANTHROPIC_BASE_URL"
```

## 扩展开发

### 添加新模型

在 `model-router.py` 的 `ENV_BY_MODEL` 中添加：

```python
ENV_BY_MODEL = {
    "kimi": { ... },
    "openai": { ... },
    "newprovider": {
        "ANTHROPIC_BASE_URL": "https://api.newprovider.com/anthropic",
        "ANTHROPIC_AUTH_TOKEN": "sk-...",
        "ANTHROPIC_MODEL": "model-name",
        # ... 其他配置
    },
}
```

### 自定义 IP 检测服务

在 `_detect_country_code()` 中添加新的检测源：

```python
def _detect_country_code():
    urls = [
        "https://ipapi.co/json/",
        "https://ipinfo.io/json",
        "http://ip-api.com/json/",
        "https://your-custom-service.com/json",  # 新增
    ]
    # ...
```

### 修改协议转换逻辑

在 `model-router-proxy.py` 中修改转换函数：

```python
def anthropic_to_openai(payload):
    openai = {}
    # 添加自定义字段映射
    if "custom_field" in payload:
        openai["mapped_field"] = payload["custom_field"]
    # ...
```

## 测试清单

### 功能测试

- [ ] `model-router kimi` 正确设置 Kimi 配置
- [ ] `model-router openai` 正确启动代理
- [ ] `model-router model` 根据 IP 正确选择
- [ ] `model-router claude` 正确启动 Claude CLI
- [ ] 环境变量正确写入注册表
- [ ] 代理健康检查通过
- [ ] 流式响应正常工作
- [ ] 工具调用正常工作

### 边界测试

- [ ] 无管理员权限时的降级处理
- [ ] 代理端口被占用时的处理
- [ ] 网络不可用时 IP 检测的处理
- [ ] 无效 API key 的错误处理

## 相关源码文件

- `model-router.py` - 主程序完整实现
- `model-router-proxy.py` - 代理服务器完整实现
